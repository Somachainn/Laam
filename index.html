<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Laam DEX - Full Trade Pairs</title>
<style>
  body {
    font-family: Arial, sans-serif;
    background: #071421;
    color: #e6eef6;
    margin: 20px;
  }
  input, select, button {
    font-size: 16px;
    padding: 8px;
    margin: 6px 0;
    width: 100%;
    max-width: 420px;
    border-radius: 6px;
    border: none;
  }
  button {
    background: #ffd36b;
    color: #071422;
    font-weight: bold;
    cursor: pointer;
  }
  table {
    width: 100%;
    max-width: 640px;
    border-collapse: collapse;
    margin-top: 12px;
  }
  th, td {
    padding: 8px;
    border-bottom: 1px solid #444;
    text-align: right;
  }
  th {
    color: #ffd36b;
    text-align: left;
  }
  caption {
    font-weight: bold;
    margin-bottom: 6px;
    color: #ffd36b;
    text-align: left;
  }
</style>
</head>
<body>
<h1>Laam DEX Full Trade Pairs</h1>
<p><strong>Secret Key:</strong></p>
<input type="password" id="secretKeyInput" placeholder="Enter your Stellar secret key" />
<button id="loadAccountBtn">Load Account</button>
<p id="accountPubKey">Public Key: -</p>

<hr />

<h2>Trade Pairs</h2>
<select id="tradePair">
  <option value="xlm_to_laam">XLM → Laam</option>
  <option value="laam_to_xlm">Laam → XLM</option>
  <option value="usdc_to_laam">USDC → Laam</option>
  <option value="laam_to_usdc">Laam → USDC</option>
  <option value="xlm_to_usdc">XLM → USDC</option>
  <option value="usdc_to_xlm">USDC → XLM</option>
</select>

<p>
  Amount (<span id="amountLabel">Source asset</span>):<br />
  <input type="number" id="tradeAmount" placeholder="Enter amount" min="0" step="any" />
</p>
<p>
  Price (in terms of source asset per destination asset, optional):<br />
  <input type="number" id="tradePrice" placeholder="Leave empty for market price" min="0" step="any" />
</p>
<button id="placeOfferBtn">Place Offer (Test)</button>

<hr />

<h2>Market Offers</h2>
<table>
  <caption>Buy Offers (Bids)</caption>
  <thead><tr><th>Price</th><th>Amount</th><th>Total</th></tr></thead>
  <tbody id="buyOffers"></tbody>
</table>

<table>
  <caption>Sell Offers (Asks)</caption>
  <thead><tr><th>Price</th><th>Amount</th><th>Total</th></tr></thead>
  <tbody id="sellOffers"></tbody>
</table>

<p id="statusMsg"></p>

<script src="https://cdnjs.cloudflare.com/ajax/libs/stellar-sdk/8.2.3/stellar-sdk.min.js"></script>
<script>
  const server = new StellarSdk.Server('https://horizon.stellar.org');

  const ASSETS = {
    xlm: StellarSdk.Asset.native(),
    laam: new StellarSdk.Asset('Laam', 'GAL4ECDAXNBMJYFCWIJ32HKVIRLCNEXY664CAZYI3EINQWPLXTMEPR64'),
    usdc: new StellarSdk.Asset('USDC', 'GA5ZSEJY5E3PXZ7XPYH2Z7DDPAU6LKFQZC5BRXEYFQJJKR5YQ6MFNNH7')
  };

  const secretInput = document.getElementById('secretKeyInput');
  const loadBtn = document.getElementById('loadAccountBtn');
  const pubKeyDisplay = document.getElementById('accountPubKey');
  const tradePairSelect = document.getElementById('tradePair');
  const amountInput = document.getElementById('tradeAmount');
  const priceInput = document.getElementById('tradePrice');
  const placeOfferBtn = document.getElementById('placeOfferBtn');
  const buyOffersTbody = document.getElementById('buyOffers');
  const sellOffersTbody = document.getElementById('sellOffers');
  const statusMsg = document.getElementById('statusMsg');
  const amountLabel = document.getElementById('amountLabel');

  let activeKeypair = null;

  function updateAmountLabel() {
    const val = tradePairSelect.value;
    const sourceAsset = val.split('_to_')[0].toUpperCase();
    amountLabel.textContent = sourceAsset;
  }

  tradePairSelect.addEventListener('change', () => {
    updateAmountLabel();
    fetchOrderbook();
    clearStatus();
  });

  function clearStatus() {
    statusMsg.textContent = '';
  }

  async function loadAccount() {
    const secret = secretInput.value.trim();
    if (!secret) {
      alert('Please enter your secret key');
      return;
    }
    try {
      activeKeypair = StellarSdk.Keypair.fromSecret(secret);
      pubKeyDisplay.textContent = 'Public Key: ' + activeKeypair.publicKey();
      statusMsg.textContent = 'Account loaded successfully.';
    } catch (e) {
      alert('Invalid secret key.');
      statusMsg.textContent = '';
      activeKeypair = null;
      pubKeyDisplay.textContent = 'Public Key: -';
    }
  }

  async function fetchOrderbook() {
    clearOffers();
    clearStatus();
    const val = tradePairSelect.value;
    const [sellingCode, buyingCode] = val.split('_to_');
    const sellingAsset = ASSETS[sellingCode];
    const buyingAsset = ASSETS[buyingCode];

    try {
      const ob = await server.orderbook(sellingAsset, buyingAsset).call();

      if (!ob.bids.length) {
        buyOffersTbody.innerHTML = '<tr><td colspan="3" style="text-align:center; color:#777;">-</td></tr>';
      } else {
        buyOffersTbody.innerHTML = ob.bids
          .map(
            (b) =>
              `<tr><td>${parseFloat(b.price).toFixed(7)}</td><td>${parseFloat(b.amount).toFixed(7)}</td><td>${(
                parseFloat(b.price) * parseFloat(b.amount)
              ).toFixed(7)}</td></tr>`
          )
          .join('');
      }

      if (!ob.asks.length) {
        sellOffersTbody.innerHTML = '<tr><td colspan="3" style="text-align:center; color:#777;">-</td></tr>';
      } else {
        sellOffersTbody.innerHTML = ob.asks
          .map(
            (a) =>
              `<tr><td>${parseFloat(a.price).toFixed(7)}</td><td>${parseFloat(a.amount).toFixed(7)}</td><td>${(
                parseFloat(a.price) * parseFloat(a.amount)
              ).toFixed(7)}</td></tr>`
          )
          .join('');
      }
    } catch (err) {
      buyOffersTbody.innerHTML = '<tr><td colspan="3" style="text-align:center; color:#f33;">Error loading offers</td></tr>';
      sellOffersTbody.innerHTML = '<tr><td colspan="3" style="text-align:center; color:#f33;">Error loading offers</td></tr>';
      console.error(err);
    }
  }

  async function placeOffer() {
    if (!activeKeypair) {
      alert('inter your secret key first.');
      return;
    }

    const amount = parseFloat(amountInput.value);
    if (isNaN(amount) || amount <= 0) {
      alert('Enter a valid amount.');
      return;
    }

    let price = priceInput.value.trim();
    if (price === '') {
      alert('Please enter price for now.');
      return;
    }
    price = parseFloat(price);
    if (isNaN(price) || price <= 0) {
      alert('Enter a valid price.');
      return;
    }

    const val = tradePairSelect.value;
    const [sellingCode, buyingCode] = val.split('_to_');
    const sellingAsset = ASSETS[sellingCode];
    const buyingAsset = ASSETS[buyingCode];

    try {
      const account = await server.loadAccount(activeKeypair.publicKey());
      const fee = await server.fetchBaseFee();

      const transaction = new StellarSdk.TransactionBuilder(account, {
        fee,
        networkPassphrase: StellarSdk.Networks.PUBLIC,
      })
        .addOperation(
          StellarSdk.Operation.manageSellOffer({
            selling: sellingAsset,
            buying: buyingAsset,
            amount: amount.toFixed(7),
            price: price.toString(),
            offerId: '0',
          })
        )
        .setTimeout(30)
        .build();

      transaction.sign(activeKeypair);

      statusMsg.textContent = 'Submitting transaction...';

      const txResult = await server.submitTransaction(transaction);
      statusMsg.textContent = 'Offer placed successfully. Tx Hash: ' + txResult.hash;

      await fetchOrderbook();
    } catch (err) {
      console.error(err);
      statusMsg.textContent = 'Error placing offer: ' + err.message;
    }
  }

  function clearOffers() {
    buyOffersTbody.innerHTML = '';
    sellOffersTbody.innerHTML = '';
  }

  loadBtn.addEventListener('click', loadAccount);
  placeOfferBtn.addEventListener('click', placeOffer);

  // Initialize
  updateAmountLabel();
  fetchOrderbook();

  tradePairSelect.addEventListener('change', () => {
    updateAmountLabel();
    fetchOrderbook();
    clearStatus();
  });
</script>
</body>
</html>
