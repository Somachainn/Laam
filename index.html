<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Laam DEX Prototype</title>
<style>
  body {
    font-family: Arial, sans-serif;
    background: #071421;
    color: #e6eef6;
    margin: 20px;
  }
  input, select, button {
    font-size: 16px;
    padding: 8px;
    margin: 6px 0;
    width: 100%;
    max-width: 400px;
    border-radius: 6px;
    border: none;
  }
  button {
    background: #ffd36b;
    color: #071422;
    font-weight: bold;
    cursor: pointer;
  }
  table {
    width: 100%;
    max-width: 600px;
    border-collapse: collapse;
    margin-top: 12px;
  }
  th, td {
    padding: 8px;
    border-bottom: 1px solid #444;
    text-align: right;
  }
  th {
    color: #ffd36b;
    text-align: left;
  }
  caption {
    font-weight: bold;
    margin-bottom: 6px;
    color: #ffd36b;
    text-align: left;
  }
</style>
</head>
<body>
<h1>Laam DEX Prototype</h1>
<p><strong>Secret Key:</strong></p>
<input type="password" id="secretKeyInput" placeholder="Enter your Stellar secret key" />
<button id="loadAccountBtn">Load Account</button>
<p id="accountPubKey">Public Key: -</p>

<hr />

<h2>Trade Pairs</h2>
<select id="tradePair">
  <option value="xlm_to_laam">XLM → Laam</option>
  <option value="usdc_to_laam">USDC → Laam</option>
  <option value="laam_to_usdc">Laam → USDC</option>
</select>

<p>
  Amount:<br />
  <input type="number" id="tradeAmount" placeholder="Enter amount" min="0" step="any" />
</p>
<p>
  Price (XLM per Laam, optional):<br />
  <input type="number" id="tradePrice" placeholder="Leave empty for market price" min="0" step="any" />
</p>
<button id="placeOfferBtn">Place Offer (Test)</button>

<hr />

<h2>Market Offers</h2>
<table>
  <caption>Buy Offers (Bids)</caption>
  <thead><tr><th>Price (XLM/Laam)</th><th>Amount (Laam)</th><th>Total (XLM)</th></tr></thead>
  <tbody id="buyOffers"></tbody>
</table>

<table>
  <caption>Sell Offers (Asks)</caption>
  <thead><tr><th>Price (XLM/Laam)</th><th>Amount (Laam)</th><th>Total (XLM)</th></tr></thead>
  <tbody id="sellOffers"></tbody>
</table>

<p id="statusMsg"></p>

<script src="https://cdnjs.cloudflare.com/ajax/libs/stellar-sdk/8.2.3/stellar-sdk.min.js"></script>
<script>
  const server = new StellarSdk.Server('https://horizon.stellar.org');
  const LAAM_CODE = 'Laam';
  const LAAM_ISSUER = 'GAL4ECDAXNBMJYFCWIJ32HKVIRLCNEXY664CAZYI3EINQWPLXTMEPR64';

  let activeKeypair = null;

  const secretInput = document.getElementById('secretKeyInput');
  const loadBtn = document.getElementById('loadAccountBtn');
  const pubKeyDisplay = document.getElementById('accountPubKey');
  const tradePairSelect = document.getElementById('tradePair');
  const amountInput = document.getElementById('tradeAmount');
  const priceInput = document.getElementById('tradePrice');
  const placeOfferBtn = document.getElementById('placeOfferBtn');
  const buyOffersTbody = document.getElementById('buyOffers');
  const sellOffersTbody = document.getElementById('sellOffers');
  const statusMsg = document.getElementById('statusMsg');

  async function loadAccount() {
    const secret = secretInput.value.trim();
    if (!secret) {
      alert('Please enter your secret key');
      return;
    }
    try {
      activeKeypair = StellarSdk.Keypair.fromSecret(secret);
      pubKeyDisplay.textContent = 'Public Key: ' + activeKeypair.publicKey();
      statusMsg.textContent = 'Account loaded successfully.';
    } catch (e) {
      alert('Invalid secret key.');
      statusMsg.textContent = '';
      activeKeypair = null;
      pubKeyDisplay.textContent = 'Public Key: -';
    }
  }

  async function fetchOrderbook() {
    try {
      const url = `https://horizon.stellar.org/order_book?selling_asset_type=credit_alphanum4&selling_asset_code=${LAAM_CODE}&selling_asset_issuer=${LAAM_ISSUER}&buying_asset_type=native`;
      const res = await fetch(url);
      const orderbook = await res.json();

      // Buy offers = bids
      buyOffersTbody.innerHTML = '';
      if (orderbook.bids.length === 0) {
        buyOffersTbody.innerHTML = '<tr><td colspan="3" style="text-align:center; color:#777;">-</td></tr>';
      } else {
        orderbook.bids.forEach((bid) => {
          const price = parseFloat(bid.price);
          const amount = parseFloat(bid.amount);
          const total = price * amount;
          buyOffersTbody.innerHTML += `<tr><td>${price.toFixed(7)}</td><td>${amount.toFixed(7)}</td><td>${total.toFixed(7)}</td></tr>`;
        });
      }

      // Sell offers = asks
      sellOffersTbody.innerHTML = '';
      if (orderbook.asks.length === 0) {
        sellOffersTbody.innerHTML = '<tr><td colspan="3" style="text-align:center; color:#777;">-</td></tr>';
      } else {
        orderbook.asks.forEach((ask) => {
          const price = parseFloat(ask.price);
          const amount = parseFloat(ask.amount);
          const total = price * amount;
          sellOffersTbody.innerHTML += `<tr><td>${price.toFixed(7)}</td><td>${amount.toFixed(7)}</td><td>${total.toFixed(7)}</td></tr>`;
        });
      }
    } catch (e) {
      console.error(e);
      statusMsg.textContent = 'Failed to fetch orderbook.';
      buyOffersTbody.innerHTML = '';
      sellOffersTbody.innerHTML = '';
    }
  }

  async function placeOffer() {
    if (!activeKeypair) {
      alert('Load your secret key first.');
      return;
    }

    const amount = parseFloat(amountInput.value);
    if (isNaN(amount) || amount <= 0) {
      alert('Enter a valid amount.');
      return;
    }

    let price = priceInput.value.trim();
    if (price === '') {
      // Use market price (best ask if selling Laam, best bid if buying Laam)
      // For simplicity, just reject here
      alert('Please enter price for now.');
      return;
    }
    price = parseFloat(price);
    if (isNaN(price) || price <= 0) {
      alert('Enter a valid price.');
      return;
    }

    const tradeType = tradePairSelect.value;

    try {
      const account = await server.loadAccount(activeKeypair.publicKey());
      const fee = await server.fetchBaseFee();

      let sellingAsset, buyingAsset;

      if (tradeType === 'xlm_to_laam') {
        sellingAsset = StellarSdk.Asset.native();
        buyingAsset = new StellarSdk.Asset(LAAM_CODE, LAAM_ISSUER);
      } else if (tradeType === 'usdc_to_laam') {
        sellingAsset = new StellarSdk.Asset('USDC', 'GA5ZSEJY5E3PXZ7XPYH2Z7DDPAU6LKFQZC5BRXEYFQJJKR5YQ6MFNNH7'); // Example USDC issuer on Stellar mainnet
        buyingAsset = new StellarSdk.Asset(LAAM_CODE, LAAM_ISSUER);
      } else if (tradeType === 'laam_to_usdc') {
        sellingAsset = new StellarSdk.Asset(LAAM_CODE, LAAM_ISSUER);
        buyingAsset = new StellarSdk.Asset('USDC', 'GA5ZSEJY5E3PXZ7XPYH2Z7DDPAU6LKFQZC5BRXEYFQJJKR5YQ6MFNNH7');
      } else {
        alert('Unsupported trade pair.');
        return;
      }

      const orderbook = await server.orderbook(sellingAsset, buyingAsset).call();

      const transaction = new StellarSdk.TransactionBuilder(account, {
        fee,
        networkPassphrase: StellarSdk.Networks.PUBLIC,
      })
        .addOperation(
          StellarSdk.Operation.manageSellOffer({
            selling: sellingAsset,
            buying: buyingAsset,
            amount: amount.toFixed(7),
            price: price.toString(),
            offerId: '0',
          })
        )
        .setTimeout(30)
        .build();

      transaction.sign(activeKeypair);

      statusMsg.textContent = 'Submitting transaction...';

      const txResult = await server.submitTransaction(transaction);
      statusMsg.textContent = 'Offer placed successfully. Tx Hash: ' + txResult.hash;

      // Refresh orderbook after offer
      await fetchOrderbook();
    } catch (err) {
      console.error(err);
      statusMsg.textContent = 'Error placing offer: ' + err.message;
    }
  }

  loadBtn.addEventListener('click', loadAccount);
  placeOfferBtn.addEventListener('click', placeOffer);

  // Fetch orderbook on load and every 30 seconds
  fetchOrderbook();
  setInterval(fetchOrderbook, 30000);
</script>
</body>
</html>
